---
title: "Applying a Multiverse to Population Habitat Analyses"
author1: "Benjamin Michael Marshall*"
author2: "Alexander Bradley Duthie**"
affiliation1: "Biological and Environmental Sciences, Faculty of Natural Sciences, University of Stirling, Stirling, FK9 4LA, Scotland, UK"
affiliation2: "-"
corresponding1: "benjaminmichaelmarshall@gmail.com"
corresponding2: "alexander.duthie@stir.ac.uk"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    template: main.tex
    keep_tex: true
    highlight: monochrome
    fig_caption: true
    dev: pdf
  bookdown::html_document2:
    theme: yeti
    highlight: monochrome
    fig_caption: true
link-citations: yes
linkcolor: gray
bibliography: [multiversePop_refs.bib, packages_refs.bib]
csl: peerj.csl
editor_options: 
  markdown: 
    wrap: sentence
abstract: abc
keywords: Movement ecology, simulation, compana, resource selection functions, step selection function, habitat preference, habitat selection, animal movement, multiverse, research choice, researcher degrees for freedom,
---

# Introduction

abc

# Methods

## Simulating the Scenarios

* Landscape simulation.

* abmAnimalMovement settings

We used the animal movement using abmAnimalMovement `r paste0("v.", packageVersion("abmAnimalMovement"))` [@abmAnimalMovement] to simulate the movement data of an animal with a predefined (i.e., known) habitat preference.
The abmAnimalMovement package provides an agent-based approach to simulating terrestrial animal movement using raster environmental data to guie the animals decisions.
We used the NLMR `r paste0("v.", packageVersion("NLMR"))` package [@NLMR] to generate the three required resource/environmental rasters: movement resistance, foraging quality, and shelter site quality.
The abmAnimalMovement package has systems for simulating activity cycles, three separate behavioural states (differing in movement characteristics and resource prioritisation), and site fidelity.
For the purposes of this study we used one of the pre-created example pseudo-species: Badger, described in the package manuscript.
In brief, the badger is a terrestrial species occupying several shelter sites, with a 8-12 hour activity cycle with minor seasonal variation, and is subject to differing movement resistance across the landscape.

For the purposes of the analysis we simplified the landscape information into categories â€“akin to the sort of land-use information more frequently available to researchers of animal movement.
We focused on foraging quality because it influences the greatest amounts of movement compared to sheltering or exploratory movements.
<!-- SHOULD WE CHANGE THE FACTOR 1 becuase it is easier to remember? -->
We converted the continuous foraging quality raster into a binary, where higher quality areas (greater than 0.5) are classed as 2, and lower quality areas as 0.

<!-- pop size needs infilling -->
We used that simulated landscape and abmAnimalMovement to simulate a population of ___, that later can be sampled from.
All individuals of this population had the same simulation settings apart from starting location.
Therefore, the variation between individuals is due to stochasticity rather than variation in the predefined habitat preference.

## Sampling and Analysis Options

* targets construction

To manage the sampling of the population and the compounding growth of subsequent analysis decisions, we used the targets `r paste0("v.", packageVersion("targets"))` and tarchetypes `r paste0("v.", packageVersion("tarchetypes"))` R packages [@targets; @tarchetypes].
These packages allowed branching workflow pipeline, while keeping track of object creation thereby optimising the compute time required to explore the multiverse of analysis choice.

### Sampling

* tracking regime

* sample size

The first decision in most animal movement studies will be concerning tracking regime.
This decision is frequently dictated by more practical considerations such as anatomy and behaviour of the animal, cost of the tracking devices, and environmental factors.
Here we aimed to cover a range of tracking regimes that vary in the frequency of location fixes (
<!-- frequncies here -->
), and the total duration of tracking (
<!-- durations here -->
).
We created subsampled datasets based on every combination of tracking frequencies and durations, provided they would result in greater than 30 datapoints per individual.

An important component of assessing population level habitat selection is the number of individuals included in analysis.
<!-- sample size info here -->
Therefore, we randomly generated a number of samples from our population of ___ simulated individuals.
We varied these samples sizes from ___ to ___ individuals, and ran ___ repeats for each size.
A sample never mixed tracking regimes.

### Analysis

Building on the decisions concerning tracking regime and population sampling, our multiverse expanded dramatically by exploring four primary analysis routes.
These routes included an area based approach using Compana analysis, and three step-based approaches including averaged individual step-selection models, two-step conditional regression models, and a Poisson model.

* area based: compana, area method, contour, available points, space sampling, type II/III, compana test
*adehabitatHS* `r paste0("v.", packageVersion("adehabitatHS"))` [@adehabitatHS],
ctmm package `r paste0("v.", packageVersion("ctmm"))` [@ctmm]

* ssf: Model Formula (SSF or iSSF), Available Points per Step, Distribution of Step Lengths, Distribution of Turn Angles, Model Averaging Method

amt `r paste0("v.", packageVersion("amt"))` [@amt]

* twoStep: Model Formula (SSF or iSSF), Available Points per Step, Distribution of Step Lengths, Distribution of Turn Angles

TwoStepCLogit `r paste0("v.", packageVersion("TwoStepCLogit"))` [@TwoStepCLogit]

* poisson: Model Formula (SSF or iSSF), Available Points per Step, Distribution of Step Lengths, Distribution of Turn Angles

INLA `r paste0("v.", packageVersion("INLA"))` [@rue_approximate_2009; @lindgren_explicit_2011; @martins_bayesian_2013; @rue_bayesian_2017; @kourounis_towards_2018]

@muff_accounting_2020

## Assessing the multiverse

* spec curves

* brm models: one per each analysis method

Specification curves provide an overview of the estimates of a given range of analyses.
Tighter more steep curves suggest greater agreement between all the analysis end points.
Here we also plotted the estimates against the different decisions that results in the estimates, allowing direct comparison on how the decision impacts the variation in the estimates.

To better detect the impact of decisions, while accounting for the random variation stemming from the differences in individuals/samples, we ran a number of Bayesian Regression Models.
The Bayesian Regression Models aimed to describe how much of the deviation from a median answer could be explained by the various sampling and analysis decisions.
For each analysis route we ran a model that included tracking frequency, tracking duration, sample size, and all the corresponding analysis choices.
All continuous variables were scaled to help determine their relative importance to each other.
<!-- add actually varaition in variables -->
For the area based Compana approach the population effects included: the continuous variable contourScaled; and the categoric predictors samplingPatternst, testrandomisation, areaMethodMCP, and typeIII.
For the step-based approaches they all included: modelFormulamf.ss, stepDistgamma, turnDistvonmises.
The step-selection model approach also included: averagingMethodNaiveaverage.

# Results

## Specification Curves

(Fig. \@ref(fig:specCurveArea)).

```{r specCurveArea, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Spec curve"}
knitr::include_graphics(here::here("notebook", "figures", "area_specCurve.png"))
```

(Fig. \@ref(fig:specCurveSSF)).

```{r specCurveSSF, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Spec curve"}
knitr::include_graphics(here::here("notebook", "figures", "ssf_specCurve.png"))
```

(Fig. \@ref(fig:specCurveTwoStep)).

```{r specCurveTwoStep, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Spec curve"}
knitr::include_graphics(here::here("notebook", "figures", "twoStep_specCurve.png"))
```

(Fig. \@ref(fig:specCurvePois)).

```{r specCurvePois, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Spec curve"}
knitr::include_graphics(here::here("notebook", "figures", "pois_specCurve.png"))
```

## Model Results

The conditional *R^2^* values differed for the three models. The Compana results model had a conditional *R^2^* of `r round(modelExtracts$r2Outputs$R2[modelExtracts$r2Outputs$model == "areaBrms" & modelExtracts$r2Outputs$Component == "conditional"], digits = 2)`; whereas the SSF model returned `r round(modelExtracts$r2Outputs$R2[modelExtracts$r2Outputs$model == "ssfBrms" & modelExtracts$r2Outputs$Component == "conditional"], digits = 2)`, and the Poisson model returned `r round(modelExtracts$r2Outputs$R2[modelExtracts$r2Outputs$model == "poisBrms" & modelExtracts$r2Outputs$Component == "conditional"], digits = 2)`.

The marginal *R^2^* represents the bulk of the conditional *R^2^* suggesting an important role for the fixed/population effects. The Compana results model had a conditional *R^2^* of `r round(modelExtracts$r2Outputs$R2[modelExtracts$r2Outputs$model == "areaBrms" & modelExtracts$r2Outputs$Component == "marginal"], digits = 2)`; whereas the SSF model returned `r round(modelExtracts$r2Outputs$R2[modelExtracts$r2Outputs$model == "ssfBrms" & modelExtracts$r2Outputs$Component == "marginal"], digits = 2)`, and the Poisson model returned `r round(modelExtracts$r2Outputs$R2[modelExtracts$r2Outputs$model == "poisBrms" & modelExtracts$r2Outputs$Component == "marginal"], digits = 2)`.

```{r test}





```
The sample size was negatively correlated with deviation from the median estimate ($\beta$ `r round(modelExtracts$betasOutputs[modelExtracts$betasOutputs$model == "ssfBrms" & modelExtracts$betasOutputs$.variable == "b_sampleSizeScaled",]$.value, digits = 2)`; 95% HDCI `r paste(round(c(modelExtracts$betasOutputs[modelExtracts$betasOutputs$model == "ssfBrms" & modelExtracts$betasOutputs$.variable == "b_sampleSizeScaled",]$.lower, modelExtracts$betasOutputs[modelExtracts$betasOutputs$model == "ssfBrms" & modelExtracts$betasOutputs$.variable == "b_sampleSizeScaled",]$.upper), digits = 2), collapse = " - ")`).


(Fig. \@ref(fig:effectPlotArea)).

```{r effectPlotArea, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Beta coefs"}

knitr::include_graphics(here::here("notebook", "figures", "areaBrms_effectsPlot.png"))
```

(Fig. \@ref(fig:effectPlotSSF)).

```{r effectPlotSSF, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Beta coefs"}
knitr::include_graphics(here::here("notebook", "figures", "ssfBrms_effectsPlot.png"))
```

(Fig. \@ref(fig:effectPlotTwoStep)).

```{r effectPlotTwoStep, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Beta coefs"}
knitr::include_graphics(here::here("notebook", "figures", "twoStepBrms_effectsPlot.png"))
```

(Fig. \@ref(fig:effectPlotPois)).

```{r effectPlotPois, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.cap="Beta coefs"}
knitr::include_graphics(here::here("notebook", "figures", "poisBrms_effectsPlot.png"))
```

# Discussion

## Limitations

## Conclusions

# Acknowledgements

BMM was funded by the Natural Environment Research Council (NERC) via the IAPETUS2 Doctoral Training Partnership.

# Software availablity

In addition to packages already mentioned in the methods we also used the following.

We used *R* `r paste0("v.", version$major, ".", version$minor)` [@base] via *RStudio* v.2023.6.2.561 [@rstudio]. <!-- version has to be manually added because rstudioapi doesn't work in targets -->
We used *here* `r paste0("v.", packageVersion("here"))` [@here] and *qs* `r paste0("v.", packageVersion("qs"))` [@qs] to manage directory addresses and saved objects.

We used *raster* `r paste0("v.", packageVersion("raster"))` [@raster] and *RandomFields* `r paste0("v.", packageVersion("RandomFields"))` [@RandomFields] to aid landscape raster creation alongside NLMR `r paste0("v.", packageVersion("NLMR"))` [@NLMR].

We used *ggplot2* `r paste0("v.", packageVersion("ggplot2"))` for creating figures [@ggplot2], with the expansions: *patchwork* `r paste0("v.", packageVersion("patchwork"))` [@patchwork], *ggridges* `r paste0("v.", packageVersion("ggridges"))` [@ggridges], and *ggdist* `r paste0("v.", packageVersion("ggdist"))` [@ggdist].

We used *brms* `r paste0("v.", packageVersion("brms"))` [@brms] to run Bayesian models, with dianogistics generated used *bayesplot* `r paste0("v.", packageVersion("bayesplot"))` [@bayesplot], *tidybayes* `r paste0("v.", packageVersion("tidybayes"))` [@tidybayes], and *performance* `r paste0("v.", packageVersion("performance"))` [@performance].

We used the *dplyr* `r paste0("v.", packageVersion("dplyr"))` [@dplyr], *tibble* `r paste0("v.", packageVersion("tibble"))` [@tibble],
<!-- *reshape2* `r paste0("v.", packageVersion("reshape2"))` [@reshape2], -->
and *stringr* `r paste0("v.", packageVersion("stringr"))` [@stringr] packages for data manipulation.

We used *sp* `r paste0("v.", packageVersion("sp"))` [@sp], *adehabitatHR* `r paste0("v.", packageVersion("adehabitatHR"))` [@adehabitatHR], *move* `r paste0("v.", packageVersion("move"))` [@move] for manipulation of spatial data and estimation of space use not otherwise mentioned in the methods.

We used rmarkdown `r paste0("v.", packageVersion("rmarkdown"))` [@rmarkdown2023; @rmarkdown2018; @rmarkdown2020], bookdown `r paste0("v.", packageVersion("bookdown"))` [@bookdown2016; @R-bookdown], tinytex `r paste0("v.", packageVersion("tinytex"))` [@tinytex2019; @tinytex2023], and knitr `r paste0("v.", packageVersion("knitr"))` [@knitr2015; @knitr2014; @knitr2023] packages to generate type-set outputs.

We generated R package citations with the aid of *grateful* `r paste0("v.", packageVersion("grateful"))` [@grateful].

# Data availabilty

<!-- add zenodo archived snapshot of github -->

# Supplementary Material

# References
